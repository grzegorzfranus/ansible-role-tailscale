---
# =============================================================================
# Ansible Role: Tailscale - Removal Tasks
# =============================================================================
# Purpose:
# - Uninstall Tailscale cleanly
# - Remove APT repository and keyring
# - Remove optional logging configuration (rsyslog, logrotate)
# - Clean up systemd override and reload daemon if needed
#
# Flow:
# 1. Stop and disable service (systemd)
# 2. Remove APT repository (signed-by)
# 3. Remove repository keyring
# 4. Remove tailscale package
# 5. Remove rsyslog configuration
# 6. Remove logrotate configuration
# 7. Remove systemd logging override (systemd only)
# 8. Reload systemd (systemd only)
# 9. Optionally remove log directory
#
# Notes:
# - These tasks are executed when tailscale_state is set to "absent".
# - Service operations are guarded for systemd only.
# - Logging directory removal is optional, controlled by tailscale_enable_logging.
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Stop and disable service (systemd)
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Stop and disable service (systemd)
  become: true
  ansible.builtin.systemd:
    name: "{{ tailscale_service_name }}"
    state: stopped
    enabled: false
    daemon_reload: true
  when: >
    ansible_facts['service_mgr'] == 'systemd'

# -----------------------------------------------------------------------------
# 2. Remove APT repository (signed-by)
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove apt repository (signed-by)
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ tailscale_repo_key_path }}] https://pkgs.tailscale.com/{{ tailscale_track }}/{{ ansible_facts['distribution'] | lower }} {{ _tailscale_version_codename }} main"
    filename: tailscale
    state: absent

# -----------------------------------------------------------------------------
# 3. Remove repository keyring
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove repository keyring
  become: true
  ansible.builtin.file:
    path: "{{ tailscale_repo_key_path }}"
    state: absent

# -----------------------------------------------------------------------------
# 4. Remove tailscale package
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove tailscale package
  become: true
  ansible.builtin.package:
    name: tailscale
    state: absent

# -----------------------------------------------------------------------------
# 5. Remove rsyslog configuration
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove rsyslog configuration
  become: true
  ansible.builtin.file:
    path: "/etc/rsyslog.d/{{ tailscale_rsyslog_config_file }}"
    state: absent

# -----------------------------------------------------------------------------
# 6. Remove logrotate configuration
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove logrotate configuration
  become: true
  ansible.builtin.file:
    path: "/etc/logrotate.d/tailscale"
    state: absent

# -----------------------------------------------------------------------------
# 7. Remove systemd logging override (systemd only)
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Remove systemd logging override
  become: true
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ tailscale_service_name }}.service.d/logging.conf"
    state: absent
  when: >
    ansible_facts['service_mgr'] == 'systemd'

# -----------------------------------------------------------------------------
# 8. Reload systemd (systemd only)
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Reload systemd if needed
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  when: >
    ansible_facts['service_mgr'] == 'systemd'

# -----------------------------------------------------------------------------
# 9. Optionally remove log directory
# -----------------------------------------------------------------------------
- name: Tailscale | remove | Optionally remove log directory
  become: true
  ansible.builtin.file:
    path: "{{ tailscale_log_dir }}"
    state: absent
  when: >
    tailscale_enable_logging | bool
